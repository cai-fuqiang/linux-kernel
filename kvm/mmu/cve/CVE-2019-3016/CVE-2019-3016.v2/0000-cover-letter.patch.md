```
From 4155c478b88ff4881870f44dbcea05223fa93424 Mon Sep 17 00:00:00 2001
From: Boris Ostrovsky <boris.ostrovsky@oracle.com>
Date: Thu, 16 Jan 2020 16:09:58 -0500
Subject: [PATCH v2 0/5] Missing TLB flushes

The KVM hypervisor may provide a guest with ability to defer remote TLB
flush when the remote VCPU is not running. When this feature is used,
the TLB flush will happen only when the remote VCPU is scheduled to run
again. This will avoid unnecessary (and expensive) IPIs.


> KVM hypervisor 可能提供guest 一个能力，当 remote VCPU 是 not running 时，
> 推迟 remote TLB flush 。当该feature 是正在备用，TLB flush 将只在 remote VCPU
> 在被schedule到再一次运行时执行。他将避免不必要的(并且代价很大) IPIs

Under certain circumstances, when a guest initiates such deferred action,
the hypervisor may miss the request. It is also possible that the guest
may mistakenly assume that it has already marked remote VCPU as needing
a flush when in fact that request had already been processed by the
hypervisor. In both cases this will result in an invalid translation
being present in a vCPU, potentially allowing accesses to memory locations
in that guest's address space that should not be accessible.

> circumstances : 环境;情形
>
> potentially : 潜在的
>
> 在某些场景下，当guest 发起了这样的 deferred action, hypervisor 可能
> 丢失了 该 request. guest可能错误的假设它已经将remote VCPU 标记为需要刷新, 
> 而实际上该请求已经被 hypervisor 处理(也就是guest没有标记)。这两者将导致 
> vCPU 中的invalid translation 仍然错在, 可能允许访问了不应该访问的guest 地址
> 空间.

Note that only intra-guest memory is vulnerable.

> vulnerable: 脆弱的; 易受…伤害的
>
> 注意，只有 guest 内部的内存是 会受到影响的。

The attached patches address both of these problems:
1. The first patch makes sure the hypervisor doesn't accidentally clear
guest's remote flush request
2. The rest of the patches prevent the race between hypervisor
acknowledging a remote flush request and guest issuing a new one.

> accidentally [æksəˈdɛntəli]:意外地;出其不意地;不知不觉地;
>
> 所附的patch解决了这两个问题:
>
> 1. 第一个patch保证 hypervisor 不会意外的 清空 guest's remote flush request
> 2. 剩余的patch阻止了 hypervisor ack了一个remote flush和guest 正在 提交了
> 一个新的他们之间的race

Boris Ostrovsky (5):
  x86/kvm: Be careful not to clear KVM_VCPU_FLUSH_TLB bit
  x86/kvm: Introduce kvm_(un)map_gfn()
  x86/kvm: Cache gfn to pfn translation
  x86/KVM: Make sure KVM_VCPU_FLUSH_TLB flag is not missed
  x86/KVM: Clean up host's steal time structure

 arch/x86/include/asm/kvm_host.h |   4 +-
 arch/x86/kvm/x86.c              |  69 +++++++++++++++---------
 include/linux/kvm_host.h        |   5 ++
 include/linux/kvm_types.h       |   9 +++-
 virt/kvm/kvm_main.c             | 113 ++++++++++++++++++++++++++++++++++------
 5 files changed, 154 insertions(+), 46 deletions(-)

-- 
1.8.3.1
```
